# Training Codes
This directory contains the final version of the training codes that I used

## SSL
This directory contains the code for training SSL on all the slides present in the tiger dataset (371). This code is taken from [here](https://github.com/srinidhiPY/SSL_CR_Histo). The weights from training are used as initial weights for TILS regressor and tumorbed network

## Patch Extraction
This directory contains some code that was used for patch extraction. The code was used to make two datasets  
- TILS dataset (patches with both tissue and cell masks)
- Tumorbed dataset (negative sampling from outside WSIBULK region, and patches from inside of WSIROI)

There are two codes for forming TILS dataset
- `Patch_Extractor_TILS.py`: This code extracts patches with both tissue and cell masks based on the label sampler `TILPatchLabelSampler.py`, extracting from slides provided by Radboud UMC in the tiger dataset
- `Patch_Extractor_TILS_TCGA.py`: This code extracts patches in the same manner from TCGA slides. I have done this because, wholeslidedata package extracted too much region outside of ROI for TCGA

Due to multiple iterations of formation of TILS dataset over the same challenge, I dont have the exact setting using which I formulated the dataset. However for newly training , this code can be used

## Tumorbed
This directory contains code for training tumorbed network which is a binary classifier for predicting relevant region (invasive, tumor associated stroma, inflame stroma) vs non relevant region

- `negative_Sampling.py`: This code does k means clustering over all negative patches to get good set of patches for non relevant region. This code gives the index of those patches. At this stage please ensure that you have patches of relevant region as well as lots of non relevant region. This code helps to get all versions of non relevant regions by picking patches from different clusters formed based on all the non relevant patches
- `train_tumorbed.py`: Main code to train the tumorbed network. This network is initialized by SSL
- `tumor_heatmap.py`: Code to visualize the heatmap generated by the tumorbed network

## TILS_Regressor
This directory contains the main code for training TILS Regressor bihead network. Please ensure that all the patches are stored at this point.
The way I trained the network was by first initializing the weights by using `SSL`. Then I ran `train_bihead_til.py` , which runs only on slides which has cell annotations also. It is trained on the colleccted TILS dataset. In order to train on slides without cell annotations, the network's til head is frozen and tissue head is then trained using `train_full_tissue_areaindv.py` which uses wholeslidedata package. The config file used is given in `Hyperparameters`. Finally, to prevent forgetting, the encoder is frozen, and the network for the last time is trained on the TILS dataset, using `train_bihead_til_freezeencoder.py`.


## Issues
If any issues or doubts on the training code, please raise an issue or contact the author.
